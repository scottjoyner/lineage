<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lineage – Level Grid (Table-like)</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <script src="/assets/common.js"></script>
</head>
<body>
<div class="wrap">

  <header>
    <h1>Lineage – Level Grid (Table-like)</h1>
    <nav class="nav">
      <a href="/index.html">Explorer</a>
      <a href="/view-dagre.html">DAG (dagre)</a>
      <a href="/view-cose-bilkent.html">Large (cose-bilkent)</a>
      <a href="/view-sbgn.html">SBGN</a>
      <a href="/view-grid.html">Level Grid</a>
    </nav>
  </header>

  <div class="panel">
    <h2>Controls</h2>
    <div class="row">
      <label><input type="radio" name="mode" value="pde" checked> PDE</label>
      <label><input type="radio" name="mode" value="site"> Website</label>
    </div>
    <div class="row"><label style="min-width:80px">Key</label><input id="key" style="flex:1" placeholder="dw.orders_fact.amount_usd"/></div>
    <div class="row"><label style="min-width:80px">Hops</label><input id="hops" type="number" value="6" min="1" max="10" style="width:90px"/></div>
    <div class="row"><label style="min-width:80px">API</label><input id="api" style="flex:1"/></div>
    <div class="row">
      <button id="load" class="primary">Load</button>
      <button id="fit">Fit</button>
      <button id="png">Export PNG</button>
      <button id="json">Export JSON</button>
    </div>
    <h2>Legend</h2>
    <div id="legend" class="legend"></div>
    <hr>
    <div class="hint">This view places layers in columns: Website | Server | Software | Directory | Feed | PDE</div>
  </div>
  <div class="panel" style="grid-column:2;grid-row:2; position:relative">
    <div id="headers" style="position:absolute;top:8px;left:8px;right:8px;display:grid;grid-template-columns:repeat(6,1fr);gap:10px;z-index:10;pointer-events:none">
      <div class="tiny">Website</div><div class="tiny">Server</div><div class="tiny">Software</div><div class="tiny">Directory</div><div class="tiny">Feed</div><div class="tiny">PDE</div>
    </div>
    <div id="cy" style="width:100%;height:100%"></div>
  </div>
</div>
<script>
(function(){
  const apiIn = document.getElementById('api'); apiIn.value = defaultApi();
  const keyIn = document.getElementById('key'); keyIn.value = 'dw.orders_fact.amount_usd';
  const hopsIn = document.getElementById('hops');
  const modeRadios = [...document.querySelectorAll('input[name="mode"]')];
  buildLegend(document.getElementById('legend'));

  const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [],
    style: baseStyle(),
    layout: { name: 'preset', fit: true }
  });

  function columnFor(type){
    return ['Website','Server','Software','Directory','Feed','PDE'].indexOf(type);
  }

  document.getElementById('load').addEventListener('click', async () => {
    const mode = modeRadios.find(r=>r.checked)?.value || 'pde';
    await loadGraph(cy, apiIn.value, mode, keyIn.value, parseInt(hopsIn.value,10)||4);

    // Compute positions by column (type) and row index
    const columns = 6;
    const padding = 80;
    const bbox = cy.extent();
    const W = cy.width(), H = cy.height();
    const colW = (W - padding*2) / columns;
    const rowH = 80;

    // Group nodes by type
    const groups = {};
    cy.nodes().forEach(n => {
      const t = n.data('type') || 'Other';
      if (!groups[t]) groups[t] = [];
      groups[t].push(n);
    });
    Object.keys(groups).forEach(t => groups[t].sort((a,b)=> (a.data('name')||'').localeCompare(b.data('name')||'')));

    const types = ['Website','Server','Software','Directory','Feed','PDE'];
    types.forEach((t, col) => {
      const arr = groups[t] || [];
      arr.forEach((n, i) => {
        n.position({
          x: padding + col*colW + colW/2,
          y: padding + i*rowH + 40
        });
      });
    });

    cy.center(); cy.fit();
  });

  document.getElementById('fit').addEventListener('click', ()=> cy.fit());
  document.getElementById('png').addEventListener('click', ()=> exportPng(cy));
  document.getElementById('json').addEventListener('click', ()=> exportJson(cy));

  document.getElementById('load').click();
})();
</script>
</body>
</html>
